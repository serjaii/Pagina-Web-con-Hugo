#!/usr/bin/env bash
set -euo pipefail

# Wrapper para construir el sitio con Hugo y publicar la carpeta public
# Asume que el repo en public/ ya está configurado y tiene remote origin

echo "Building site with hugo..."
hugo "$@"

if [ ! -d public ]; then
  echo "Error: la carpeta public/ no existe después de la build" >&2
  exit 1
fi

pushd public > /dev/null

  # Agregar y commitear cambios
  git add --all

  COMMIT_MSG="Actualizar sitio: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"

  # Commit si hay cambios
  if git diff --staged --quiet && git diff --quiet; then
    echo "No hay cambios en public/ — nada que publicar"
  else
    git commit -m "$COMMIT_MSG" || true
    
    # Push al repositorio remoto (asume que origin ya está configurado)
    git push origin main
    echo "Publicado public/ -> origin/main"
  fi

popd > /dev/null

echo "Done."
